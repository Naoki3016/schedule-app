<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OB訪問 ご希望時間選択</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1 id="ob-greeting">{{ ob_name }}様、ご希望の時間を選択してください</h1>
            <p>ご多忙のところ恐れ入ります。以下の候補より、ご希望の時間帯を一つお選びください。</p>
        </header>

        <main>
            <div class="booking-section">
                <div id="available-slots">
                    {% set has_available_slots = false %}
                    {% set current_ob_has_booking = false %}
                    {% for slot, booked_by in schedule.items()|sort %}
                        {% if booked_by is none %}
                            {% set has_available_slots = true %}
                            <button class="slot-option" data-slot="{{ slot }}">{{ slot }}</button>
                        {% elif booked_by == ob_name %}
                            {% set current_ob_has_booking = true %}
                            <button class="slot-option booked-by-me" data-slot="{{ slot }}">{{ slot }} (あなたの予約)</button>
                        {% else %}
                            <button class="slot-option booked-by-other" data-slot="{{ slot }}" disabled>{{ slot }} (予約済み)</button>
                        {% endif %}
                    {% endfor %}
                    
                    {% if not has_available_slots and not current_ob_has_booking %}
                        <p class="placeholder-text">現在、予約可能な時間がありません。管理者にご確認ください。</p>
                    {% endif %}
                </div>
                <button id="confirm-booking-btn" disabled>この時間で確定する</button>
                <p id="result-message"></p>
            </div>
        </main>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const availableSlotsDiv = document.getElementById('available-slots');
        const confirmBtn = document.getElementById('confirm-booking-btn');
        const resultMessage = document.getElementById('result-message');
        let selectedSlot = null;

        // Pre-select current booking if exists
        const currentBookingButton = document.querySelector('.slot-option.booked-by-me');
        if (currentBookingButton) {
            currentBookingButton.classList.add('selected');
            selectedSlot = currentBookingButton.dataset.slot;
            confirmBtn.disabled = false;
        }

        availableSlotsDiv.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('slot-option') && !target.classList.contains('booked-by-other')) {
                // Remove selection from previously selected slot
                const currentlySelected = document.querySelector('.slot-option.selected');
                if (currentlySelected) {
                    currentlySelected.classList.remove('selected');
                }

                // Add selection to the new one
                target.classList.add('selected');
                selectedSlot = target.dataset.slot;
                confirmBtn.disabled = false;
            }
        });

        confirmBtn.addEventListener('click', () => {
            if (!selectedSlot) return;

            // Disable button to prevent multiple clicks
            confirmBtn.disabled = true;
            resultMessage.textContent = '予約処理中...';
            resultMessage.style.color = '#007bff';

            fetch('/book', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ob_name: "{{ ob_name }}", slot: selectedSlot })
            })
            .then(res => res.json())
            .then(data => {
                resultMessage.textContent = data.message;
                if (data.status === 'success') {
                    resultMessage.style.color = '#28a745';
                    // Visually update the booked slot
                    document.querySelectorAll('.slot-option').forEach(btn => {
                        if (btn.dataset.slot === selectedSlot) {
                            btn.classList.remove('selected');
                            btn.classList.remove('booked-by-other'); // In case it was previously booked by other
                            btn.classList.add('booked-by-me');
                            btn.textContent = `${selectedSlot} (あなたの予約)`;
                            btn.disabled = false; // Re-enable for potential re-selection
                        } else if (btn.classList.contains('booked-by-me')) {
                            // If it was previously booked by me, now it's free
                            btn.classList.remove('booked-by-me');
                            btn.classList.remove('selected');
                            btn.textContent = btn.dataset.slot;
                            btn.disabled = false;
                        }
                    });
                    // Disable other already booked slots
                    document.querySelectorAll('.slot-option.booked-by-other').forEach(btn => btn.disabled = true);

                } else {
                    resultMessage.style.color = '#dc3545';
                    alert(data.message); // Show alert for errors like race conditions
                    // Re-enable button on error
                    confirmBtn.disabled = false;
                    // Reload the page to show the latest availability if booking failed due to race condition
                    location.reload(); 
                }
            })
            .catch(error => {
                console.error('Error booking slot:', error);
                resultMessage.textContent = '予約中にエラーが発生しました。';
                resultMessage.style.color = '#dc3545';
                confirmBtn.disabled = false;
            });
        });
    });
    </script>
</body>
</html>
